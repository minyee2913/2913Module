"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bdsx_1 = require("bdsx");
const command_1 = require("bdsx/bds/command");
const event_1 = require("bdsx/event");
const nativetype_1 = require("bdsx/nativetype");
const colors_1 = require("colors");
const fs_1 = require("fs");
const __1 = require("..");
const packets_1 = require("../packets");
bdsx_1.ipfilter.setTrafficLimit(1000000);
bdsx_1.ipfilter.setTrafficLimitPeriod(10 * 60);
///////////////////////////////////////////////////////////////////////
let config = {
    LocalData: '../scriptData/ban.json',
    Ban_command: 'ban_',
    IpBan_command: 'ipban_',
    UnBan_command: 'unban_',
    Ban_msg: '§cYou are BANNED',
    IpBan_msg: '§cYou are Ip BANNED',
    UnBan_msg: '§a${target} is UNBANNED',
    announce: '§e${target} was BANNED By ${origin}'
};
//////////////////////////////////////////////////////////////////////
fs_1.open(config.LocalData, 'a+', function (err, fd) {
    if (err)
        throw err;
    try {
        JSON.parse(fs_1.readFileSync(config.LocalData, "utf8"));
    }
    catch (err) {
        fs_1.writeFileSync(config.LocalData, '{ "IpBan": [{"ip": "","name":""}], "NameBan": [] }', "utf8");
    }
});
bdsx_1.command.register(config.Ban_command, "ban Command", command_1.CommandPermissionLevel.Operator).overload((p, o, ut) => {
    let targets = [];
    for (const actor of p.player.newResults(o)) {
        if (!actor.isPlayer()) {
            packets_1.sendText(o.getName(), '§c§lOnly Player!!!');
            return;
        }
        targets.push(actor);
    }
    if (targets.length > 1) {
        packets_1.sendText(o.getName(), '§c§lOnly 1 Player!!!');
        return;
    }
    let target = targets[0].getNetworkIdentifier();
    let targetName = __1.NameById(target);
    console.log(`${targetName} banned`);
    bdsx_1.bedrockServer.executeCommand(`tellraw @a {"rawtext":[{"text":"${config.announce.replace('${target}', `${targetName}`).replace('${origin}', `${o.getName()}`)}"}]}`);
    const BanJS = JSON.parse(fs_1.readFileSync(config.LocalData, "utf8"));
    BanJS.NameBan.push(targetName);
    fs_1.writeFileSync(config.LocalData, JSON.stringify(BanJS, null, 4), "utf8");
    if (__1.playerList.includes(o.getName()))
        __1.Disconnect(target, config.Ban_msg);
}, { player: command_1.ActorWildcardCommandSelector });
bdsx_1.command.register(config.IpBan_command, "Ipban Command", command_1.CommandPermissionLevel.Operator).overload((p, o, ut) => {
    let targets = [];
    for (const actor of p.player.newResults(o)) {
        if (!actor.isPlayer()) {
            packets_1.sendText(o.getName(), '§c§lOnly Player!!!');
            return;
        }
        targets.push(actor);
    }
    if (targets.length > 1) {
        packets_1.sendText(o.getName(), '§c§lOnly 1 Player!!!');
        return;
    }
    let target = targets[0].getNetworkIdentifier();
    let targetName = __1.NameById(target);
    let [ip, port] = target.getAddress().split('|');
    let js = {
        ip: ip,
        name: targetName
    };
    console.log(`${o.getName()} Ip banned ${targetName}\nip : ${ip} port : ${port}`);
    bdsx_1.bedrockServer.executeCommand(`tellraw @a {"rawtext":[{"text":"${config.announce.replace('${target}', `${targetName}`).replace('${origin}', `${o.getName()}`)}"}]}`);
    const BanJS = JSON.parse(fs_1.readFileSync(config.LocalData, "utf8"));
    BanJS.IpBan.push(js);
    fs_1.writeFileSync(config.LocalData, JSON.stringify(BanJS), "utf8");
    __1.Disconnect(target, config.IpBan_msg);
}, { player: command_1.ActorWildcardCommandSelector });
bdsx_1.command.register(config.UnBan_command, "Unban Command", command_1.CommandPermissionLevel.Operator).overload((p, o, ut) => {
    let targetName = p.targetName;
    console.log(`${o.getName()} Unbanned ${targetName}`);
    bdsx_1.bedrockServer.executeCommand(`tellraw @p[name="${o.getName()}"] {"rawtext":[{"text":"${config.UnBan_msg.replace('${target}', `${targetName}`).replace('${origin}', `${o.getName()}`)}"}]}`);
    const BanJS = JSON.parse(fs_1.readFileSync(config.LocalData, "utf8"));
    let Nstate = BanJS.NameBan.indexOf(targetName);
    BanJS.NameBan.splice(Nstate, 1);
    let Ijs = BanJS.IpBan.map((e, i) => e.name);
    let Istate = Ijs.indexOf(targetName);
    BanJS.IpBan.splice(Istate, 1);
    fs_1.writeFileSync(config.LocalData, JSON.stringify(BanJS, null, 4), "utf8");
}, { targetName: nativetype_1.CxxString });
event_1.events.packetAfter(bdsx_1.MinecraftPacketIds.Login).on((ptr, networkidentifier, packetId) => {
    let target = String(networkidentifier);
    let targetName = __1.NameById(networkidentifier);
    let [ip, port] = target.split('|');
    const BanJS = JSON.parse(fs_1.readFileSync(config.LocalData, "utf8"));
    let Ijs = BanJS.IpBan.map((e, i) => e.ip);
    setTimeout(function () {
        if (BanJS.NameBan.includes(targetName))
            __1.Disconnect(networkidentifier, config.Ban_msg);
        if (Ijs.includes(ip))
            __1.Disconnect(networkidentifier, config.IpBan_msg);
    }, 3000);
});
console.log(colors_1.yellow('*') + colors_1.white(' ban'));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYmFuLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQXNHO0FBQ3RHLDhDQUF3RjtBQUN4RixzQ0FBb0M7QUFDcEMsZ0RBQTRDO0FBQzVDLG1DQUE4QztBQUM5QywyQkFBOEU7QUFDOUUsMEJBQWtGO0FBQ2xGLHdDQUFzQztBQUN0QyxlQUFRLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ2xDLGVBQVEsQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLEdBQUMsRUFBRSxDQUFDLENBQUM7QUFDdEMsdUVBQXVFO0FBRXZFLElBQUksTUFBTSxHQUNWO0lBQ0ksU0FBUyxFQUFFLHdCQUF3QjtJQUNuQyxXQUFXLEVBQUUsTUFBTTtJQUNuQixhQUFhLEVBQUUsUUFBUTtJQUN2QixhQUFhLEVBQUUsUUFBUTtJQUN2QixPQUFPLEVBQUUsa0JBQWtCO0lBQzNCLFNBQVMsRUFBRSxxQkFBcUI7SUFDaEMsU0FBUyxFQUFFLHlCQUF5QjtJQUNwQyxRQUFRLEVBQUUscUNBQXFDO0NBQ2xELENBQUE7QUFFRCxzRUFBc0U7QUFFdEUsU0FBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUMsSUFBSSxFQUFDLFVBQVMsR0FBRyxFQUFDLEVBQUU7SUFDMUMsSUFBRyxHQUFHO1FBQUUsTUFBTSxHQUFHLENBQUM7SUFDbEIsSUFBSTtRQUNBLElBQUksQ0FBQyxLQUFLLENBQUMsaUJBQVksQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7S0FDdEQ7SUFBQyxPQUFPLEdBQUcsRUFBRTtRQUNWLGtCQUFhLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxvREFBb0QsRUFBRSxNQUFNLENBQUMsQ0FBQztLQUNqRztBQUNELENBQUMsQ0FBQyxDQUFDO0FBRUgsY0FBTyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLGFBQWEsRUFBRSxnQ0FBc0IsQ0FBQyxRQUFRLENB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